version: 2
plan:
  project-key: BT
  key: WSCLIEN
  name: WS-Client - Build

stages:
- Default Stage:
    manual: false
    final: false
    jobs:
    - Default Job

Default Job:
  key: JOB1
  requirements:
  - 'system.jdk.JDK 17'
  - 'system.builder.mvn3.Maven 3'
  tasks:
  - clean

  # Repositories
  - checkout:
      force-clean-build: true
      description: Checkout Default Repository
  - checkout:
      repository: bamboo-deployment
      path: bamboo-deployment
      force-clean-build: true
      description: Checkout bamboo-deployment repository

  # Optional cache hygiene
  - script:
      interpreter: BINSH_OR_CMDEXE
      scripts:
      - |
        rm -rf ~/.m2/repository/gov/gsa/ || true
        yum install -y jq || true
      description: Remove existing cnxs maven repo directory & ensure jq

  # Ensure bamboo-deployment branch (portable; force bash)
  - script:
      interpreter: SHELL
      working-dir: bamboo-deployment
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        TARGET_BRANCH="${BAMBOO_DEPLOYMENT_BRANCH:-develop}"
        echo "Target branch: ${TARGET_BRANCH}"
        git fetch --all --prune
        git checkout -B "${TARGET_BRANCH}" "origin/${TARGET_BRANCH}" || git checkout -B "${TARGET_BRANCH}"
        git log -1 --oneline
        BASH
      description: Ensure bamboo-deployment branch

  # Discover endpoints & write settings-ca.xml + file.properties (CodeArtifact)
  - script:
      interpreter: SHELL
      file: bamboo-deployment/build-determination-migration.sh
      description: Determine parent branch and pass correct variables

  # Ensure the two files exist in job root
  - script:
      interpreter: SHELL
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        if [ -f ./file.properties ] && [ -f ./settings-ca.xml ]; then
          echo "file.properties and settings-ca.xml already present"
          ls -l file.properties settings-ca.xml
        else
          SRC=bamboo-deployment
          [ -f ./file.properties ] || cp -f "${SRC}/file.properties" ./ || { echo "Missing file.properties"; exit 5; }
          [ -f ./settings-ca.xml ] || cp -f "${SRC}/settings-ca.xml" ./ || { echo "Missing settings-ca.xml"; exit 6; }
          ls -l file.properties settings-ca.xml
        fi
        BASH
      description: Ensure file.properties & settings-ca.xml are in job root

  # Make endpoints available to later tasks
  - inject-variables:
      file: file.properties
      scope: LOCAL
      namespace: inject
      description: Inject values

  # (Optional) dump non-sensitive vars BEFORE token injection
  - any-task:
      plugin-key: com.atlassian.bamboo.plugins.bamboo-variable-inject-plugin:dump
      configuration: {}

  # Ensure CodeArtifact has Maven Central external connection (like Common)
  - script:
      interpreter: SHELL
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        AWS_REGION="us-east-1"
        CA_DOMAIN="cnxsartifact"
        CA_OWNER="339713019047"

        ensure_external () {
          local raw="$1"; local trimmed="${raw%/}"; local repo="${trimmed##*/}"
          echo "Ensuring external connection 'public:maven-central' on repo: ${repo}"
          aws codeartifact associate-external-connection \
            --domain "$CA_DOMAIN" --domain-owner "$CA_OWNER" --region "$AWS_REGION" \
            --repository "$repo" --external-connection public:maven-central >/dev/null 2>&1 \
            && echo "Associated." || echo "Already present or not required."
        }

        ensure_external "${bamboo.inject.resolveRepositoryUrl}"
        ensure_external "${bamboo.inject.pluginRepositoryUrl}"
        BASH
      description: Ensure CodeArtifact has Maven Central external connection

  # Fetch a short-lived CodeArtifact token (LOCAL scope, masked)
  - script:
      interpreter: SHELL
      scripts:
      - |
        set +x
        echo "caToken.password=$(aws codeartifact get-authorization-token \
          --domain cnxsartifact --query authorizationToken --output text --region us-east-1)" > ca-token.properties
      description: Fetch CodeArtifact token (masked)

  # Inject token as a Bamboo variable (masked via namespace + *.password)
  - inject-variables:
      file: ca-token.properties
      scope: LOCAL
      namespace: inject
      description: Inject CodeArtifact token (masked)

  # Preflight to CodeArtifact
  - script:
      interpreter: SHELL
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        RAW="${bamboo.inject.resolveRepositoryUrl}"
        BASE="${RAW%/}"
        TRY1="${BASE}/gov/gsa/cnxs/bom/env/maven-metadata.xml"
        TRY2="${BASE}/"

        probe () {
          url="$1"
          code="$(curl -sS -o /dev/null -w '%{http_code}' -I "$url" || echo 000)"
          case "$code" in
            200|204|301|302|401|403) echo "Preflight OK: $url -> $code"; return 0;;
            *) echo "Preflight: $url -> $code"; return 1;;
          esac
        }
        echo "Preflight HEAD: ${TRY1}"
        probe "${TRY1}" || { echo "Preflight HEAD: ${TRY2}"; probe "${TRY2}" || { echo "Preflight FAILED"; exit 2; }; }
        BASH
      description: Preflight â€“ verify CodeArtifact reachable

  # Write a final Maven settings that mirrors CodeArtifact (snapshots OK)
  - script:
      interpreter: SHELL
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        export CODEARTIFACT_AUTH_TOKEN="${bamboo.inject.caToken.password}"

        RAW_RESOLVE="${bamboo.inject.resolveRepositoryUrl}"
        REPO_URL="${RAW_RESOLVE%/}"
        RAW_PLUGIN="${bamboo.inject.pluginRepositoryUrl}"
        PLUG_URL="${RAW_PLUGIN%/}"

        cat > settings-final.xml <<'XML'
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
          <mirrors>
            <mirror>
              <id>codeartifact</id>
              <mirrorOf>*</mirrorOf>
              <url>__REPO_URL__</url>
            </mirror>
          </mirrors>
          <profiles>
            <profile>
              <id>codeartifact</id>
              <repositories>
                <repository>
                  <id>codeartifact</id>
                  <url>__REPO_URL__</url>
                  <releases><enabled>true</enabled></releases>
                  <snapshots><enabled>true</enabled><updatePolicy>always</updatePolicy></snapshots>
                </repository>
              </repositories>
              <pluginRepositories>
                <pluginRepository>
                  <id>codeartifact</id>
                  <url>__PLUG_URL__</url>
                  <releases><enabled>true</enabled></releases>
                  <snapshots><enabled>true</enabled></snapshots>
                </pluginRepository>
              </pluginRepositories>
            </profile>
          </profiles>
          <activeProfiles><activeProfile>codeartifact</activeProfile></activeProfiles>
          <servers>
            <server>
              <id>codeartifact</id>
              <username>aws</username>
              <password>${env.CODEARTIFACT_AUTH_TOKEN}</password>
            </server>
          </servers>
        </settings>
        XML

        sed -i "s#__REPO_URL__#${REPO_URL}#g" settings-final.xml
        sed -i "s#__PLUG_URL__#${PLUG_URL}#g" settings-final.xml
        echo "Wrote settings-final.xml"
        grep -E '(<url>|<activeProfile>|<id>codeartifact</id>)' -n settings-final.xml || true
        BASH
      description: Write final Maven settings for CodeArtifact (snapshots enabled)

  # Build via Script so we can export the token and use settings-final.xml
  - script:
      interpreter: SHELL
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        export CODEARTIFACT_AUTH_TOKEN="${bamboo.inject.caToken.password}"

        MVN_BIN="$(command -v mvn || echo /usr/share/maven/bin/mvn)"
        echo "Using Maven: ${MVN_BIN}"
        "${MVN_BIN}" -v || true

        # NOTE: removed -Dbamboo.inject.BranchName to avoid bad substitution if missing.
        "${MVN_BIN}" -s settings-final.xml \
          clean verify -B -U \
          -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
        BASH
      description: WS-Client Build and Verify (CodeArtifact)

  # Optional deploy (publish SNAPSHOT/RELEASE to discovered repo)
  - script:
      interpreter: SHELL
      scripts:
      - |
        bash -Eeuo pipefail <<'BASH'
        export CODEARTIFACT_AUTH_TOKEN="${bamboo.inject.caToken.password}"

        MVN_BIN="$(command -v mvn || echo /usr/share/maven/bin/mvn)"

        # Determine version for logging
        V="$("${MVN_BIN}" -s settings-final.xml -q -DskipTests \
              -Dexec.executable=echo -Dexec.args='${project.version}' \
              --non-recursive org.codehaus.mojo:exec-maven-plugin:3.5.0:exec | tail -n1)"
        echo "Project version = ${V}"

        # Use discovered deploy endpoint (same as plugin/resolve for feature branch)
        RAW="${bamboo.inject.pluginRepositoryUrl}"
        DEPLOY_URL="${RAW%/}"
        echo "Deploying to: ${DEPLOY_URL}"

        "${MVN_BIN}" -s settings-final.xml -B -DskipTests -DdeployAtEnd=true \
          -DaltDeploymentRepository="codeartifact::${DEPLOY_URL}" \
          clean deploy
        BASH
      description: Deploy artifact to CodeArtifact repository

  # Cleanup token file
  - script:
      interpreter: SHELL
      scripts:
      - rm -f ca-token.properties || true
      description: Cleanup token file

  # Persist info for downstream
  - inject-variables:
      file: file.properties
      scope: RESULT
      namespace: inject
      description: Inject the build information to be used in Bamboo Deploy

variables:
  buildVersionQueryArtifact: ws-client-war
  buildVersionQueryGroup: gov.gsa.cnxs.wsclient

repositories:
- WS-Client:
    scope: global
- bamboo-deployment:
    scope: global

triggers:
- bitbucket-server-trigger:
    repositories:
    - WS-Client

branches:
  create: for-new-branch
  delete:
    after-deleted-days: 7
    after-inactive-days: 200
  link-to-jira: true

notifications:
- events: [plan-failed]
  recipients: [responsible, committers]
- events: [plan-completed]
  recipients: [watchers]
- events: [plan-failed]
  recipients: [responsible, committers]

labels: []

dependencies:
  require-all-stages-passing: false
  enabled-for-branches: true
  block-strategy: block_if_parent_in_progress
  plans:
  - BT-VE
  - BT-WEBSV