with slaactivity (rowid, statehistory_id, object_id, state, state_time, output) as (select row_number() over (order by object_id, state_time) rowid, statehistory_id, object_id, state, state_time, output from icinga_statehistory where state_type = 1 and state in (0,2) and object_id = 292 and state_time between '2020-01-13' and '2020-04-22') select d.state_time as downtime, u.state_time as uptime, (date_part('day', u.state_time - d.state_time) * 24 * 60 + date_part('hour', u.state_time - d.state_time) * 60 + date_part('minute', u.state_time - d.state_time)) as duration, d.output as output from (select * from slaactivity where state = 2) d inner join (select * from slaactivity where state = 0) u on d.rowid = u.rowid-1 and u.object_id = d.object_id;