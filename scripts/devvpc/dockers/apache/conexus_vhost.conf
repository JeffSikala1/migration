<VirtualHost *:80>
    ServerName https://${SERVER_NAME}
    ServerAdmin Conexus.help@gsa.gov
    UseCanonicalName On
    SetEnv proxy-nokeepalive 1    
    
    ErrorDocument 404 /errors/404.html
    ErrorDocument 500 /errors/50x.html
    ErrorDocument 502 /errors/50x.html
    ErrorDocument 503 /errors/50x.html
    ErrorDocument 504 /errors/50x.html
    
    DocumentRoot /var/www/html
    ProxyPass /errors !
    RewriteEngine on
    # Disable TRACE and TRACK
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS)
    RewriteRule .* - [F]
 
    <Files ~ "\.(cgi|shtml|phtml|php3?)$">
      SSLOptions +StdEnvVars
    </Files>
    <Directory "/var/www/cgi-bin">
      SSLOptions +StdEnvVars
    </Directory>
 
#    ProxyPass /wiki/ !
#    Alias "/wiki/" "/app/conexus-wiki/"
#    <Directory "/app/conexus-wiki">
#      Require all granted
#      <LimitExcept POST GET>
#        Require all granted
#      </LimitExcept>
#      <IfVersion >= 2.4>
#        # Forward PHP requests to FPM
#        SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
#        <FilesMatch "\.php$">
#            SetHandler "proxy:fcgi://127.0.0.1:9000"
#            ErrorDocument 503 /errors/50x.html
#        </FilesMatch>
#      </IfVersion>
#    </Directory>
    
    ProxyPass /help !
    Alias "/help" "/app/conexus-help/"
    <Directory "/app/conexus-help">
      Require all granted
      <LimitExcept POST GET>
        Require all granted
      </LimitExcept>
    </Directory>
    
    ProxyPass /refdata/ !
    Alias "/refdata/" "/app/conexus/attachments/refdata/current/"
    <Directory "/app/conexus/attachments/refdata/current/">
      Require all granted
      <LimitExcept GET>
        Require all granted
      </LimitExcept>
    </Directory>
    
    # Redirect to maint. page if maintenane.enable file is present
    RewriteCond %{DOCUMENT_ROOT}/maintenance/maintenance.enable -f
    # Allow IP address ranges in during maintenance
    #RewriteCond %{REMOTE_ADDR} !149.101.*
    # Allow content from the /errors/ directory
    RewriteCond %{THE_REQUEST} !/errors/maintenance.html [NC]
    RewriteRule ^.* /errors/maintenance.html [L]

    # Redirect maint. page to landing page
    RewriteCond %{DOCUMENT_ROOT}/maintenance/maintenance.enable !-f
    RewriteCond %{THE_REQUEST} /errors/maintenance.html$ [NC]
    RewriteRule .* https://%{HTTP_HOST}/ [L]

    # Prevent ErrorDocuments from being redirected to landing page
    RewriteCond %{ENV:REDIRECT_STATUS} 200}
    RewriteCond %{REQUEST_URI} /errors/.* [NC]
    RewriteRule .* https://%{HTTP_HOST}/ [L]

    # Prevent 404 Not Found for javascript/css source maps
    RewriteCond %{REQUEST_URI}  (\.map)$
    RewriteRule (.*)  /errors/404.map [QSA]

    Protocols h2
    H2Upgrade on
 
    #ErrorLog logs/ssl_error_log
    #CustomLog logs/access_log splunk_kv env=!dontlog
    #CustomLog logs/ssl_request_log "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
    #CustomLog "logs/ssl_request_log" request_log  env=!dontlog

    <Directory "/var/www/html/errors/">
        Options -Indexes
        Require all granted
        AllowOverride None
    </Directory>

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyErrorOverride Off

    TraceEnable off

    ######### IAA Attachments #########
    # Proxy to the AntiVirus host
    ProxyPassMatch ^/(secure/rest/agencies/\d+/interAgencyAgreements/\d+/attachments/file)$ http://${AVSERVER}/$1 

    ######### Order Attachments #########
    # Proxy to the AntiVirus host
    ProxyPassMatch ^/(secure/rest/orders/\d+/attachments/file)$ http://${AVSERVER}/$1 

    ######### Reporting #########
    # Proxy to the Jboss Reporting host
    ProxyPass /secure/rest/reporting/ http://reporting:8080/secure/rest/reporting/ 

    ######### Rest backend #########
    # Proxy to the Jboss Portal host
    ProxyPass        /secure/    http://portal:8080/secure/
    ProxyPassReverse /secure/    http://portal:8080/secure/
    # Handle the occassion where the UI requests /secure
    ProxyPass        /secure     http://portal:8080/secure/
    ProxyPassReverse /secure     http://portal:8080/secure/

    # Used for the local ui public content
    Alias "/" "/app/conexus-ui-public/"
    <Directory "/app/conexus-ui-public/">
      Options -Indexes -MultiViews +FollowSymlinks
      AllowOverride None
      Require all granted
    </Directory>
    
    # Restrict viewing of subdirectories
    <DirectoryMatch "^/app/conexus-ui-public/(.+)/">
      Options -Indexes 
      Order Deny,Allow
      Allow From All
    </DirectoryMatch>

    # HSTS (mod_headers is required) (31536000 seconds = 1 year)
   # Header always set Strict-Transport-Security "max-age=31536000; includeSubdomains; preload"
   # RequestHeader set x-request-id %{UNIQUE_ID}e
    
    # User Tracking
    #CookieDomain .gsa.gov
    #CookieName LkgAk9XB9h5D8tPX
    #CookieTracking on
    CookieHTTPOnly on
    CookieSecure on
    
    # Set Expiration times to 0
    ExpiresActive On
    ExpiresDefault "now"
    
    # Cookie over SSL
    Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure
    
    # X-Frame protection
    Header always set X-Frame-Options SAMEORIGIN
    
    # X-XSS protection
    Header set X-XSS-Protection "1; mode=block"
    
    # X-Content-Type-Options
    Header set X-Content-Type-Options nosniff
    
    # Hide X-Powered-By and Server headers, sent by downstream application servers:
    # Note you need both below as the "always" one doesn't work with Jboss for some reason
    Header always unset "X-Powered-By"
    Header unset "X-Powered-By"

    #Header set Cache-Control no-store
    Header set Access-Control-Allow-Origin conexus.gsa.gov
</VirtualHost>

